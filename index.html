<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lead Scout - Results</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d0d0d;
      min-height: 100vh;
      color: #e0e0e0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      padding: 30px 0;
      border-bottom: 1px solid #222;
      margin-bottom: 30px;
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 5px;
    }

    header p {
      color: #666;
      font-size: 0.9rem;
    }

    .stats {
      display: flex;
      gap: 30px;
      margin: 20px 0 30px;
      flex-wrap: wrap;
    }

    .stat {
      color: #888;
      font-size: 0.85rem;
    }

    .stat strong {
      color: #fff;
      font-weight: 600;
    }

    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .search-box {
      flex: 1;
      min-width: 200px;
      max-width: 350px;
    }

    .search-box input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #333;
      border-radius: 6px;
      background: #1a1a1a;
      color: #fff;
      font-size: 0.9rem;
    }

    .search-box input::placeholder {
      color: #555;
    }

    .search-box input:focus {
      outline: none;
      border-color: #444;
    }

    select {
      padding: 10px 14px;
      border: 1px solid #333;
      border-radius: 6px;
      background: #1a1a1a;
      color: #fff;
      font-size: 0.9rem;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: #444;
    }

    select option {
      background: #1a1a1a;
    }

    .leads-list {
      display: flex;
      flex-direction: column;
      gap: 1px;
      background: #222;
      border-radius: 8px;
      overflow: hidden;
    }

    .lead-card {
      background: #141414;
      padding: 20px 24px;
      display: grid;
      grid-template-columns: 56px 1fr auto;
      gap: 16px;
      align-items: start;
      transition: background 0.15s;
    }

    .lead-card:hover {
      background: #1a1a1a;
    }

    .avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      overflow: hidden;
      background: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      font-weight: 500;
      color: #888;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .lead-main {
      min-width: 0;
    }

    .lead-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }

    .lead-name a {
      color: inherit;
      text-decoration: none;
    }

    .lead-name a:hover {
      text-decoration: underline;
    }

    .lead-role {
      color: #999;
      font-size: 0.95rem;
      margin-bottom: 3px;
    }

    .lead-company {
      color: #888;
      font-size: 0.9rem;
      margin-bottom: 6px;
    }

    .lead-location {
      color: #666;
      font-size: 0.85rem;
      margin-bottom: 10px;
    }

    .lead-searched-company {
      color: #555;
      font-size: 0.8rem;
      font-style: italic;
      margin-bottom: 6px;
    }

    .lead-company-meta {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .meta-tag {
      padding: 2px 6px;
      background: #2a2a2a;
      border-radius: 3px;
      font-size: 0.7rem;
      color: #888;
    }

    .meta-tag.index {
      background: #2d3748;
      color: #90cdf4;
    }

    .meta-tag.country {
      background: #2d3a2d;
      color: #9ae6b4;
    }

    .meta-tag.sector {
      background: #3d2d3d;
      color: #d6bcfa;
    }

    .lead-snippet {
      margin-top: 10px;
      padding: 10px 12px;
      background: #1a1a1a;
      border-radius: 6px;
      font-size: 0.85rem;
      line-height: 1.5;
      color: #888;
    }

    .lead-snippet .highlight-topic {
      background: #3b4f2a;
      color: #9ece6a;
      padding: 1px 4px;
      border-radius: 3px;
      font-weight: 500;
    }

    .lead-snippet .highlight-role {
      color: #fff;
      font-weight: 600;
    }

    .lead-topics {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .topic-tag {
      padding: 3px 8px;
      background: #3b4f2a;
      border-radius: 4px;
      font-size: 0.75rem;
      color: #9ece6a;
      font-weight: 500;
    }

    .toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #888;
      font-size: 0.9rem;
      cursor: pointer;
      user-select: none;
    }

    .toggle-label:hover {
      border-color: #444;
    }

    .toggle-label input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #9ece6a;
    }

    .lead-card.no-topic-match {
      opacity: 0.6;
      border-left: 3px solid #555;
    }

    .no-match-badge {
      display: inline-block;
      padding: 2px 6px;
      background: #3a3a3a;
      border-radius: 4px;
      font-size: 0.7rem;
      color: #888;
      margin-left: 8px;
    }

    .lead-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      text-decoration: none;
      text-align: center;
      transition: all 0.15s;
      cursor: pointer;
      border: none;
      white-space: nowrap;
    }

    .btn-primary {
      background: #2563eb;
      color: #fff;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid #333;
      color: #888;
    }

    .btn-secondary:hover {
      border-color: #444;
      color: #aaa;
    }

    .lead-meta {
      font-size: 0.75rem;
      color: #555;
      margin-top: 4px;
    }

    .no-results {
      text-align: center;
      padding: 60px 20px;
      color: #555;
    }

    .no-results h3 {
      font-size: 1.1rem;
      margin-bottom: 8px;
      color: #666;
      font-weight: 500;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #555;
    }

    .error {
      padding: 30px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      margin: 20px 0;
    }

    .error h3 {
      color: #e55;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .error p {
      color: #888;
      font-size: 0.9rem;
    }

    .error code {
      display: block;
      margin-top: 15px;
      padding: 12px;
      background: #0d0d0d;
      border-radius: 6px;
      font-size: 0.8rem;
      color: #888;
    }

    footer {
      text-align: center;
      padding: 30px 20px;
      color: #444;
      font-size: 0.8rem;
    }

    @media (max-width: 768px) {
      .lead-card {
        grid-template-columns: 48px 1fr;
        gap: 12px;
      }

      .avatar {
        width: 48px;
        height: 48px;
      }

      .lead-actions {
        grid-column: 1 / -1;
        flex-direction: row;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Lead Scout</h1>
      <p>LinkedIn X-Ray Search Results</p>
    </header>

    <div class="stats" id="stats">
      <div class="stat"><strong id="total-leads">-</strong> leads</div>
      <div class="stat"><strong id="with-topic-match">-</strong> with topic match</div>
      <div class="stat"><strong id="companies-count">-</strong> companies</div>
    </div>

    <div class="controls">
      <div class="search-box">
        <input type="text" id="search" placeholder="Search name, role, company...">
      </div>
      <select id="index-filter">
        <option value="">All Indices</option>
      </select>
      <select id="country-filter">
        <option value="">All Countries</option>
      </select>
      <select id="sector-filter">
        <option value="">All Sectors</option>
      </select>
      <select id="searched-company-filter">
        <option value="">All Companies</option>
      </select>
      <select id="sort-by">
        <option value="date-desc">Newest</option>
        <option value="date-asc">Oldest</option>
        <option value="name-asc">Name A-Z</option>
        <option value="company-asc">Company A-Z</option>
      </select>
      <label class="toggle-label">
        <input type="checkbox" id="topic-filter" checked>
        <span>Topic match only</span>
      </label>
    </div>

    <div id="content">
      <div class="loading">Loading...</div>
    </div>

    <footer>
      Lead Scout - Module A
    </footer>
  </div>

  <script>
    function getInitials(name) {
      return name
        .split(' ')
        .map(n => n[0])
        .join('')
        .toUpperCase()
        .slice(0, 2);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Search keywords to highlight
    const SEARCH_ROLES = [
      "Head", "Lead", "Principal", "Director", "VP", "Chief",
      "Staff", "Senior", "Architect", "Manager"
    ];

    const SEARCH_TOPICS = [
      "Agentic AI", "AI Agents", "Autonomous Agents", "Multi-Agent",
      "LLM Orchestration", "AI Automation", "Agent Framework"
    ];

    function highlightKeywords(text) {
      if (!text) {
        return '';
      }

      // Escape text first
      let result = escapeHtml(text);

      // Highlight topics first (they're longer, avoids partial matches)
      SEARCH_TOPICS.forEach(keyword => {
        const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${escapedKeyword})`, 'gi');
        result = result.replace(regex, '<span class="highlight-topic">$1</span>');
      });

      // Highlight roles (use word boundaries to avoid partial matches)
      SEARCH_ROLES.forEach(keyword => {
        const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`\\b(${escapedKeyword})\\b`, 'gi');
        result = result.replace(regex, '<span class="highlight-role">$1</span>');
      });

      return result;
    }

    function createLeadCard(lead) {
      const initials = getInitials(lead.name);
      const hasTopicMatch = lead.hasTopicMatch !== false && (lead.matchedTopics?.length > 0);

      const avatarContent = lead.imageUrl
        ? `<img src="${escapeHtml(lead.imageUrl)}" alt="" onerror="this.parentElement.innerHTML='${initials}'">`
        : initials;

      const locationHtml = lead.location
        ? `<div class="lead-location">${escapeHtml(lead.location)}</div>`
        : '';

      // Show searchedCompany if it differs from the extracted company
      const searchedCompanyHtml = lead.searchedCompany && lead.searchedCompany !== lead.company
        ? `<div class="lead-searched-company">Searched: ${escapeHtml(lead.searchedCompany)}</div>`
        : '';

      // Show company metadata (index, country, sector)
      const meta = getCompanyMeta(lead);
      const companyMetaHtml = meta ? `
        <div class="lead-company-meta">
          <span class="meta-tag index">${escapeHtml(meta.index)}</span>
          <span class="meta-tag country">${escapeHtml(meta.country)}</span>
          <span class="meta-tag sector">${escapeHtml(meta.sector)}</span>
        </div>
      ` : '';

      const matchedTopics = lead.matchedTopics || [];

      const snippetHtml = lead.snippet
        ? `<div class="lead-snippet">${highlightKeywords(lead.snippet)}</div>`
        : '';

      const topicsHtml = matchedTopics.length > 0
        ? `<div class="lead-topics">${matchedTopics.map(t => `<span class="topic-tag">${escapeHtml(t)}</span>`).join('')}</div>`
        : '';

      const noMatchBadge = !hasTopicMatch
        ? '<span class="no-match-badge">No topic match</span>'
        : '';

      const cardClass = hasTopicMatch ? 'lead-card' : 'lead-card no-topic-match';

      return `
        <div class="${cardClass}">
          <div class="avatar">${avatarContent}</div>
          <div class="lead-main">
            <div class="lead-name"><a href="${escapeHtml(lead.linkedinUrl)}" target="_blank" rel="noopener">${escapeHtml(lead.name)}</a>${noMatchBadge}</div>
            <div class="lead-role">${escapeHtml(lead.role)}</div>
            <div class="lead-company">${escapeHtml(lead.company)}</div>
            ${companyMetaHtml}
            ${searchedCompanyHtml}
            ${locationHtml}
            ${snippetHtml}
            ${topicsHtml}
          </div>
          <div class="lead-actions">
            <a href="${escapeHtml(lead.linkedinUrl)}" target="_blank" rel="noopener" class="btn btn-primary">View Profile</a>
            <button class="btn btn-secondary" onclick="copyLink('${escapeHtml(lead.linkedinUrl)}')">Copy Link</button>
          </div>
        </div>
      `;
    }

    function copyLink(url) {
      navigator.clipboard.writeText(url);
    }

    let allLeads = [];
    let companyLookup = {}; // Map company name -> {index, country, sector}

    // Get company metadata by searchedCompany name
    function getCompanyMeta(lead) {
      // Try searchedCompany first, then extracted company
      return companyLookup[lead.searchedCompany] || companyLookup[lead.company] || null;
    }

    function renderLeads(leads) {
      const content = document.getElementById('content');

      if (leads.length === 0) {
        content.innerHTML = `
          <div class="no-results">
            <h3>No leads found</h3>
            <p>Try adjusting your search or filters</p>
          </div>
        `;
        return;
      }

      content.innerHTML = `
        <div class="leads-list">
          ${leads.map(createLeadCard).join('')}
        </div>
      `;
    }

    function updateStats(leads) {
      document.getElementById('total-leads').textContent = leads.length;
      const withTopicMatch = leads.filter(l => l.hasTopicMatch !== false && l.matchedTopics?.length > 0).length;
      document.getElementById('with-topic-match').textContent = withTopicMatch;
      document.getElementById('companies-count').textContent = new Set(leads.map(l => l.company)).size;
    }

    function populateFilters(leads) {
      // Helper to populate a select element
      function populateSelect(selectId, values) {
        const select = document.getElementById(selectId);
        while (select.options.length > 1) {
          select.remove(1);
        }
        values.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = value;
          select.appendChild(option);
        });
      }

      // Populate searched company filter
      const searchedCompanies = [...new Set(leads.map(l => l.searchedCompany).filter(Boolean))].sort();
      populateSelect('searched-company-filter', searchedCompanies);

      // Populate index, country, sector filters from company lookup
      const indices = [...new Set(Object.values(companyLookup).map(c => c.index))].sort();
      const countries = [...new Set(Object.values(companyLookup).map(c => c.country))].sort();
      const sectors = [...new Set(Object.values(companyLookup).map(c => c.sector))].sort();

      populateSelect('index-filter', indices);
      populateSelect('country-filter', countries);
      populateSelect('sector-filter', sectors);

      console.log(`Filters populated: ${indices.length} indices, ${countries.length} countries, ${sectors.length} sectors`);
    }

    function filterAndSort() {
      const searchTerm = document.getElementById('search').value.toLowerCase();
      const indexFilter = document.getElementById('index-filter').value;
      const countryFilter = document.getElementById('country-filter').value;
      const sectorFilter = document.getElementById('sector-filter').value;
      const searchedCompanyFilter = document.getElementById('searched-company-filter').value;
      const sortBy = document.getElementById('sort-by').value;
      const topicFilterEnabled = document.getElementById('topic-filter').checked;

      let filtered = allLeads.filter(lead => {
        const matchesSearch = !searchTerm ||
          lead.name.toLowerCase().includes(searchTerm) ||
          lead.role.toLowerCase().includes(searchTerm) ||
          lead.company.toLowerCase().includes(searchTerm) ||
          (lead.searchedCompany && lead.searchedCompany.toLowerCase().includes(searchTerm)) ||
          (lead.location && lead.location.toLowerCase().includes(searchTerm));

        const matchesSearchedCompany = !searchedCompanyFilter || lead.searchedCompany === searchedCompanyFilter;

        // Check index, country, sector against company metadata
        const meta = getCompanyMeta(lead);
        const matchesIndex = !indexFilter || (meta && meta.index === indexFilter);
        const matchesCountry = !countryFilter || (meta && meta.country === countryFilter);
        const matchesSector = !sectorFilter || (meta && meta.sector === sectorFilter);

        const hasTopicMatch = lead.hasTopicMatch !== false && (lead.matchedTopics?.length > 0);
        const matchesTopic = !topicFilterEnabled || hasTopicMatch;

        return matchesSearch && matchesSearchedCompany && matchesIndex && matchesCountry && matchesSector && matchesTopic;
      });

      filtered.sort((a, b) => {
        switch (sortBy) {
          case 'date-desc':
            return new Date(b.discoveredAt) - new Date(a.discoveredAt);
          case 'date-asc':
            return new Date(a.discoveredAt) - new Date(b.discoveredAt);
          case 'name-asc':
            return a.name.localeCompare(b.name);
          case 'company-asc':
            return a.company.localeCompare(b.company);
          default:
            return 0;
        }
      });

      renderLeads(filtered);
    }

    async function loadLeads() {
      try {
        // Load both leads and company data in parallel
        const [leadsResponse, companiesResponse] = await Promise.all([
          fetch(`output/leads.json?t=${Date.now()}`),
          fetch(`data/target-companies.json?t=${Date.now()}`)
        ]);

        if (!leadsResponse.ok) {
          throw new Error(`Leads: HTTP ${leadsResponse.status}`);
        }

        allLeads = await leadsResponse.json();
        console.log(`Loaded ${allLeads.length} leads from leads.json`);

        if (!Array.isArray(allLeads)) {
          throw new Error('Invalid leads data format');
        }

        // Load company metadata if available
        if (companiesResponse.ok) {
          const companiesData = await companiesResponse.json();
          // Create lookup map by company name
          companiesData.companies.forEach(company => {
            companyLookup[company.name] = {
              index: company.index,
              country: company.country,
              sector: company.sector
            };
          });
          console.log(`Loaded ${Object.keys(companyLookup).length} companies for metadata lookup`);
        } else {
          console.warn('Could not load target-companies.json, metadata filters disabled');
        }

        updateStats(allLeads);
        populateFilters(allLeads);

        document.getElementById('search').addEventListener('input', filterAndSort);
        document.getElementById('index-filter').addEventListener('change', filterAndSort);
        document.getElementById('country-filter').addEventListener('change', filterAndSort);
        document.getElementById('sector-filter').addEventListener('change', filterAndSort);
        document.getElementById('searched-company-filter').addEventListener('change', filterAndSort);
        document.getElementById('sort-by').addEventListener('change', filterAndSort);
        document.getElementById('topic-filter').addEventListener('change', filterAndSort);

        // Apply initial filter and render (checkbox is checked by default)
        filterAndSort();

      } catch (error) {
        document.getElementById('content').innerHTML = `
          <div class="error">
            <h3>Could not load leads</h3>
            <p>Make sure output/leads.json exists.</p>
            <code>Error: ${escapeHtml(error.message)}</code>
            <p style="margin-top: 15px;">Run: <code style="display:inline; padding: 4px 8px;">npm run view</code> then open http://localhost:3000</p>
          </div>
        `;
      }
    }

    loadLeads();
  </script>
</body>
</html>
